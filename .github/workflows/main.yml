name: Secure RDP Setup

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:

      - name: Configure Core RDP Settings
        run: |
          Write-Host "Configuring RDP and Firewall..."

          # Enable Remote Desktop and disable NLA
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "SecurityLayer" -Value 0 -Force

          # Recreate firewall rule
          netsh advfirewall firewall delete rule name="RDP-Tailscale" > $null 2>&1
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

          # Restart RDP service to apply changes
          try {
              Restart-Service -Name TermService -Force -ErrorAction Stop
              Write-Host "RDP service restarted successfully"
          } catch {
              Write-Host "Warning: TermService restart failed or not needed"
          }

      - name: Create RDP User with Secure Password
        run: |
          Write-Host "Creating secure RDP user..."

          # Generate a strong random password (PowerShell 7+ safe)
          Add-Type -AssemblyName System.Security
          $charSet = @(
            'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
            'abcdefghijklmnopqrstuvwxyz',
            '0123456789',
            '!@#$%^&*()_-+='
          )
          $password = -join ((1..16) | ForEach-Object { 
              $set = $charSet[(Get-Random -Minimum 0 -Maximum $charSet.Count)]
              $set[(Get-Random -Minimum 0 -Maximum $set.Length)]
          })

          $securePass = ConvertTo-SecureString $password -AsPlainText -Force

          # Create or update the user
          try {
              New-LocalUser -Name "RDP" -Password $securePass -FullName "RDP Access User" -AccountNeverExpires -ErrorAction Stop
              Write-Host "User 'RDP' created successfully"
          } catch {
              Write-Host "User 'RDP' already exists. Updating password..."
              Set-LocalUser -Name "RDP" -Password $securePass
          }

          # Add user to groups
          Add-LocalGroupMember -Group "Administrators" -Member "RDP" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP" -ErrorAction SilentlyContinue

          # Save credentials for later steps
          Add-Content -Path $env:GITHUB_ENV -Value "RDP_USERNAME=RDP"
          Add-Content -Path $env:GITHUB_ENV -Value "RDP_PASSWORD=$password"

          Write-Host "RDP user setup complete."

      - name: Install Tailscale
        run: |
          Write-Host "Installing Tailscale..."
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"

          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -ErrorAction Stop
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force -ErrorAction SilentlyContinue

          Start-Sleep -Seconds 5
          Write-Host "Tailscale installed."

      - name: Connect to Tailscale
        run: |
          Write-Host "Connecting to Tailscale..."
          $tailscaleExe = "$env:ProgramFiles\Tailscale\tailscale.exe"

          if (-not (Test-Path $tailscaleExe)) {
              Write-Error "Tailscale executable not found at $tailscaleExe"
              exit 1
          }

          # Ensure auth key exists
          if (-not "${{ secrets.TAILSCALE_AUTH_KEY }}") {
              Write-Error "TAILSCALE_AUTH_KEY not found in repository secrets"
              exit 1
          }

          # Bring up Tailscale
          & $tailscaleExe up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname="gh-rdp-${{ github.run_id }}" --accept-routes --reset

          # Wait for IP assignment
          $tsIP = $null
          for ($i = 0; $i -lt 12; $i++) {
              Start-Sleep -Seconds 5
              $tsIP = & $tailscaleExe ip -4 2>$null
              if ($tsIP) { break }
          }

          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned after waiting"
              & $tailscaleExe status
              exit 1
          }

          Add-Content -Path $env:GITHUB_ENV -Value "TAILSCALE_IP=$tsIP"
          Write-Host "Tailscale connected successfully with IP: $tsIP"

      - name: Verify RDP Accessibility
        run: |
          Write-Host "Verifying RDP access..."
          $ip = "$env:TAILSCALE_IP"
          $test = Test-NetConnection -ComputerName $ip -Port 3389
          if ($test.TcpTestSucceeded) {
              Write-Host "‚úÖ RDP port (3389) accessible through Tailscale!"
          } else {
              Write-Error "‚ùå RDP port 3389 not reachable!"
              exit 1
          }

      - name: Display Connection Details
        run: |
          Write-Host ""
          Write-Host "============================================="
          Write-Host "üéâ RDP Setup Completed Successfully!"
          Write-Host "============================================="
          Write-Host "üîπ Tailscale IP: $env:TAILSCALE_IP"
          Write-Host "üîπ Username: $env:RDP_USERNAME"
          Write-Host "üîπ Password: $env:RDP_PASSWORD"
          Write-Host "üîπ Port: 3389"
          Write-Host ""
          Write-Host "üëâ Steps to Connect:"
          Write-Host "1. Connect your local device to the same Tailscale network"
          Write-Host "2. Open Remote Desktop Connection (mstsc)"
          Write-Host "3. Enter the IP shown above"
          Write-Host "4. Login using credentials above"
          Write-Host "============================================="

      - name: Keep RDP Session Active
        run: |
          Write-Host "Keeping RDP session alive..."
          while ($true) {
              Write-Host "[$(Get-Date)] RDP active ‚Äî press Ctrl+C in workflow to terminate."
              Start-Sleep -Seconds 300
          }
