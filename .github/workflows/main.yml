name: Windows RDP Setup

on:
  workflow_dispatch:
    inputs:
      timeout_minutes:
        description: 'RDP session duration (minutes)'
        required: true
        default: '360'
        type: string

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: ${{ fromJson(inputs.timeout_minutes) }}

    steps:
    - name: Check Windows Version
      run: |
        Write-Host "Windows Version:"
        systeminfo | findstr /B /C:"OS Name" /C:"OS Version"
        
    - name: Configure RDP Settings
      run: |
        Write-Host "Configuring RDP settings..."
        
        # Enable Remote Desktop
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0 -Force
        
        # Disable NLA for easier connection
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0 -Force
        
        # Set security layer
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "SecurityLayer" -Value 0 -Force
        
        # Configure encryption
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "MinEncryptionLevel" -Value 2 -Force
        
        Write-Host "RDP registry settings configured"

    - name: Configure Windows Firewall
      run: |
        Write-Host "Configuring firewall rules..."
        
        # Remove existing rules to avoid conflicts
        netsh advfirewall firewall delete rule name="RDP-Port-3389" 2>$null
        netsh advfirewall firewall delete rule name="RDP-Tailscale" 2>$null
        
        # Add firewall rule for RDP
        netsh advfirewall firewall add rule name="RDP-Port-3389" dir=in action=allow protocol=TCP localport=3389 enable=yes
        
        # Also allow UDP for better performance
        netsh advfirewall firewall add rule name="RDP-UDP-3389" dir=in action=allow protocol=UDP localport=3389 enable=yes
        
        Write-Host "Firewall rules configured"

    - name: Restart RDP Services
      run: |
        Write-Host "Restarting RDP services..."
        
        try {
            Restart-Service -Name "TermService" -Force -ErrorAction Stop
            Write-Host "TermService restarted successfully"
        }
        catch {
            Write-Host "Failed to restart TermService: $_"
        }
        
        # Start additional RDP-related services
        $services = @("SessionEnv", "UmRdpService")
        foreach ($service in $services) {
            try {
                Set-Service -Name $service -StartupType Automatic -ErrorAction SilentlyContinue
                Start-Service -Name $service -ErrorAction SilentlyContinue
                Write-Host "Service $service configured"
            }
            catch {
                Write-Host "Service $service not available or already running"
            }
        }

    - name: Create RDP User Account
      run: |
        Write-Host "Creating RDP user account..."
        
        # Generate secure random password
        Add-Type -AssemblyName System.Web
        $password = [System.Web.Security.Membership]::GeneratePassword(16, 4)
        $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
        
        # Create user
        try {
            New-LocalUser -Name "RDPUser" -Password $securePassword -FullName "RDP User" -Description "Temporary RDP user for GitHub Actions" -AccountNeverExpires -ErrorAction Stop
            Write-Host "User RDPUser created successfully"
        }
        catch {
            Write-Host "User may already exist, updating password..."
            Set-LocalUser -Name "RDPUser" -Password $securePassword -ErrorAction Stop
        }
        
        # Add to required groups
        Add-LocalGroupMember -Group "Administrators" -Member "RDPUser" -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDPUser" -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Users" -Member "RDPUser" -ErrorAction SilentlyContinue
        
        # Store credentials in environment
        echo "RDP_USERNAME=RDPUser" >> $env:GITHUB_ENV
        echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
        
        Write-Host "User account setup completed"

    - name: Install Tailscale
      run: |
        Write-Host "Installing Tailscale..."
        
        $tailscaleUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-amd64.msi"
        $installerPath = "$env:TEMP\tailscale-setup.msi"
        
        # Download Tailscale
        try {
            Invoke-WebRequest -Uri $tailscaleUrl -OutFile $installerPath -ErrorAction Stop
            Write-Host "Tailscale downloaded successfully"
        }
        catch {
            Write-Error "Failed to download Tailscale: $_"
            exit 1
        }
        
        # Install Tailscale
        try {
            Start-Process msiexec.exe -ArgumentList @("/i", "`"$installerPath`"", "/quiet", "/norestart", "/qn") -Wait -NoNewWindow
            Write-Host "Tailscale installation completed"
        }
        catch {
            Write-Error "Failed to install Tailscale: $_"
            exit 1
        }
        
        # Cleanup installer
        Remove-Item $installerPath -Force -ErrorAction SilentlyContinue
        
        # Wait for service to start
        Start-Sleep -Seconds 10

    - name: Connect to Tailscale
      run: |
        Write-Host "Connecting to Tailscale..."
        
        # Verify Tailscale executable exists
        $tailscaleExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
        if (-not (Test-Path $tailscaleExe)) {
            Write-Error "Tailscale executable not found at $tailscaleExe"
            exit 1
        }
        
        # Check if auth key is provided
        if (-not "${{ secrets.TAILSCALE_AUTH_KEY }}") {
            Write-Error "Tailscale auth key not found in GitHub secrets"
            Write-Host "Please add TAILSCALE_AUTH_KEY to your repository secrets"
            exit 1
        }
        
        # Connect to Tailscale
        try {
            & $tailscaleExe up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname="github-rdp-$env:GITHUB_RUN_ID" --accept-routes --accept-dns=false --reset
            Write-Host "Tailscale connection command executed"
        }
        catch {
            Write-Error "Failed to execute Tailscale up command: $_"
            exit 1
        }
        
        # Wait for IP assignment with retries
        $maxRetries = 12
        $retryCount = 0
        $tailscaleIP = $null
        
        while ($retryCount -lt $maxRetries -and -not $tailscaleIP) {
            Start-Sleep -Seconds 10
            $retryCount++
            
            try {
                $tailscaleIP = & $tailscaleExe ip -4 2>$null
                if ($LASTEXITCODE -eq 0 -and $tailscaleIP) {
                    Write-Host "Tailscale IPv4 obtained: $tailscaleIP"
                    break
                }
            }
            catch {
                Write-Host "Attempt $retryCount failed: $_"
            }
            
            Write-Host "Waiting for Tailscale IP... ($retryCount/$maxRetries)"
        }
        
        if (-not $tailscaleIP) {
            Write-Error "Failed to get Tailscale IP after $maxRetries attempts"
            Write-Host "Tailscale status:"
            & $tailscaleExe status
            exit 1
        }
        
        # Store IP in environment
        echo "TAILSCALE_IP=$tailscaleIP" >> $env:GITHUB_ENV
        Write-Host "Tailscale setup completed successfully"

    - name: Verify RDP Connectivity
      run: |
        Write-Host "Verifying RDP connectivity..."
        
        $ip = "$env:TAILSCALE_IP"
        $port = 3389
        
        Write-Host "Testing connection to $ip`:$port"
        
        # Test TCP connection
        $tcpTest = Test-NetConnection -ComputerName $ip -Port $port -WarningAction SilentlyContinue
        
        if ($tcpTest.TcpTestSucceeded) {
            Write-Host "âœ“ RDP port 3389 is accessible via Tailscale"
        } else {
            Write-Host "âœ— RDP port 3389 is not accessible"
            Write-Host "Checking local RDP status..."
            
            # Check local RDP status
            $localTest = Test-NetConnection -ComputerName localhost -Port 3389 -WarningAction SilentlyContinue
            if ($localTest.TcpTestSucceeded) {
                Write-Host "âœ“ RDP is running locally but not accessible via Tailscale"
                Write-Host "This may be a Tailscale routing issue"
            } else {
                Write-Host "âœ— RDP is not running locally"
            }
        }
        
        # Display network information
        Write-Host "`nNetwork Information:"
        ipconfig | findstr IPv4
        & "$env:ProgramFiles\Tailscale\tailscale.exe" status

    - name: Display Connection Information
      run: |
        Write-Host ""
        Write-Host "================================================"
        Write-Host "ðŸŽ‰ RDP SETUP COMPLETED SUCCESSFULLY!"
        Write-Host "================================================"
        Write-Host "ðŸŒ Connect using this information:"
        Write-Host "   IP Address: $env:TAILSCALE_IP"
        Write-Host "   Username: $env:RDP_USERNAME"
        Write-Host "   Password: $env:RDP_PASSWORD"
        Write-Host "   Port: 3389 (default)"
        Write-Host ""
        Write-Host "ðŸ“ Connection steps:"
        Write-Host "   1. Ensure you're connected to same Tailscale network"
        Write-Host "   2. Use Windows Remote Desktop Connection"
        Write-Host "   3. Enter the IP address above"
        Write-Host "   4. Use credentials shown above"
        Write-Host ""
        Write-Host "â° Session will timeout in ${{ github.event.inputs.timeout_minutes }} minutes"
        Write-Host "================================================"
        Write-Host ""

    - name: Keep RDP Session Active
      run: |
        Write-Host "RDP session is now active..."
        Write-Host "Press Ctrl+C in GitHub Actions to terminate early"
        Write-Host "Session started at: $(Get-Date)"
        
        $timeoutMinutes = ${{ github.event.inputs.timeout_minutes }}
        $checkInterval = 30 # seconds
        $totalChecks = [math]::Ceiling(($timeoutMinutes * 60) / $checkInterval)
        $checksDone = 0
        
        while ($checksDone -lt $totalChecks) {
            $checksDone++
            $timeRemaining = $timeoutMinutes - (($checksDone * $checkInterval) / 60)
            
            Write-Host "[$(Get-Date)] RDP Active - Time remaining: ~$([math]::Round($timeRemaining, 1)) minutes"
            
            # Verify services are still running
            try {
                $rdpService = Get-Service -Name TermService -ErrorAction SilentlyContinue
                $tailscaleService = Get-Service -Name Tailscale -ErrorAction SilentlyContinue
                
                if ($rdpService.Status -ne "Running") {
                    Write-Warning "RDP service is not running!"
                }
                
                if ($tailscaleService.Status -ne "Running") {
                    Write-Warning "Tailscale service is not running!"
                }
            }
            catch {
                Write-Host "Service check failed: $_"
            }
            
            Start-Sleep -Seconds $checkInterval
        }
        
        Write-Host "RDP session timeout reached. Shutting down..."

    - name: Cleanup (Optional)
      if: always()
      run: |
        Write-Host "Cleaning up..."
        
        # Disable RDP
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 1 -Force
        
        # Remove firewall rules
        netsh advfirewall firewall delete rule name="RDP-Port-3389" 2>$null
        netsh advfirewall firewall delete rule name="RDP-UDP-3389" 2>$null
        
        # Remove user (optional)
        # Remove-LocalUser -Name "RDPUser" -ErrorAction SilentlyContinue
        
        Write-Host "Cleanup completed"
